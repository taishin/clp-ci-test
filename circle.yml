machine:
  ruby:
    version:
      2.1.2

test:
  override:
    - instanceid=`aws ec2 run-instances --image-id ami-29160d47 --count 1 --instance-type t2.micro --key-name sasaki-20160511 --security-group-ids sg-f69d1192 --subnet-id subnet-50c6c827 --associate-public-ip-address | jq -r '.Instances[].InstanceId'`
    - echo $instanceid
    - sleep 20
    - publicip=`aws ec2 describe-instances --instance-id $instanceid | jq -r '.Reservations[] .Instances[] .PublicIpAddress'`
    - echo $publicip
    - echo "$publicip testserver" >> /tmp/hosts.txt
    - cp /etc/hosts .
    - sudo bash -c "cat hosts /tmp/hosts.txt | tee /etc/hosts"
    - ping testserver